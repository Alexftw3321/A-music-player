<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player - Fixed Queue Repeat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            display: flex;
            flex-direction: column; 
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            overflow-y: auto;
        }
        .music-player-container {
            width: 95%;
            max-width: 600px; 
            background-color: #2d3748;
            border-radius: 1.5rem; 
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.5);
            padding: 1rem;
        }
        .album-art-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        .album-art {
            width: 70%; 
            max-width: 280px;
            aspect-ratio: 1 / 1; 
            object-fit: cover;
            border-radius: 50%; 
            transition: all 0.5s ease-in-out;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        .album-art.playing {
            transform: scale(1.02);
            box-shadow: 0 0 25px rgba(99, 179, 237, 1);
        }
        .song-info {
            text-align: center;
            margin-bottom: 1rem;
            min-height: 50px;
        }
        .song-title {
            font-size: 1.6rem;
            font-weight: bold;
            color: #cbd5e0;
        }
        .song-artist {
            font-size: 1rem;
            color: #a0aec0;
        }
        .progress-container {
            width: 100%;
            height: 8px;
            background-color: #4a5568;
            border-radius: 0.5rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }
        .progress-bar {
            height: 100%;
            background-color: #63b3ed;
            border-radius: 0.5rem;
            transition: width 0.1s linear;
        }
        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #a0aec0;
            margin-bottom: 1rem;
        }
        .controls-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.2rem;
        }
        .control-btn {
            position: relative;
            background: none;
            border: none;
            color: #e2e8f0;
            font-size: 1.6rem;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.5rem;
        }
        .control-btn:hover:not(:disabled) {
            color: #90cdf4;
            transform: scale(1.1);
        }
        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .main-play-btn {
            font-size: 3.5rem;
            color: #63b3ed;
        }
        .control-btn.active { color: #63b3ed !important; }
        .repeat-one-badge {
            position: absolute;
            top: 2px;
            right: 0px;
            font-size: 0.7rem;
            font-weight: bold;
            background: #63b3ed;
            color: #1a202c;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .queue-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 0.5rem;
            margin-top: 1.5rem; 
            border-bottom: 2px solid #63b3ed;
        }
        .queue-container {
            max-height: 250px;
            overflow-y: auto;
            padding-top: 0.5rem;
            touch-action: pan-y;
        }
        .queue-item {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #4a5568;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 0.5rem;
            transition: 0.2s;
            background: #2d3748;
            user-select: none;
        }
        .queue-item.active {
            border-left: 4px solid #63b3ed;
            color: #63b3ed;
        }
        .drag-handle { 
            color: #718096; 
            cursor: grab; 
            padding: 10px;
            touch-action: none; 
        }
        .queue-item.dragging {
            opacity: 0.5;
            background: #4a5568;
        }
        .track-info { flex-grow: 1; cursor: pointer; }
        .remove-btn { color: #f56565; font-size: 1.2rem; padding: 5px; cursor: pointer; }

        #volume-slider { width: 70%; cursor: pointer; }
    </style>
</head>
<body>
    <div class="music-player-container">
        <div class="album-art-wrapper">
            <img id="album-art" src="https://placehold.co/450x450/2d3748/fff?text=No+Track" alt="Album Art" class="album-art">
        </div>

        <div class="player-controls">
            <div class="song-info">
                <div id="song-title" class="song-title">Select a song</div>
                <div id="song-artist" class="song-artist"></div>
            </div>

            <div class="progress-container" id="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>

            <div class="time-display">
                <span id="current-time">0:00</span>
                <span id="duration">0:00</span>
            </div>

            <div class="flex items-center justify-center gap-4 mb-4">
                <i class="fas fa-volume-up text-gray-400"></i>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.7">
            </div>

            <div class="controls-row">
                <button id="shuffle-btn" class="control-btn text-gray-400"><i class="fas fa-random"></i></button>
                <button id="prev-btn" class="control-btn"><i class="fas fa-backward"></i></button>
                <button id="play-pause-btn" class="control-btn main-play-btn"><i class="fas fa-play"></i></button>
                <button id="next-btn" class="control-btn"><i class="fas fa-forward"></i></button>
                <button id="repeat-btn" class="control-btn text-gray-400"><i class="fas fa-repeat"></i></button>
            </div>
        </div>
        
        <div class="queue-header-row">
            <h2 class="text-xl font-bold">Queue</h2>
            <div class="flex gap-4">
                <button id="clear-btn" class="text-red-400 text-sm hover:underline">Clear</button>
                <button id="load-btn" class="control-btn text-blue-400 p-0"><i class="fas fa-plus-circle"></i></button>
            </div>
        </div>

        <div id="queue-container" class="queue-container"></div>
    </div>

    <audio id="audio-player"></audio>
    <input type="file" id="file-input" accept="audio/*" class="hidden">

    <script>
        const audioPlayer = document.getElementById('audio-player');
        const albumArt = document.getElementById('album-art');
        const songTitle = document.getElementById('song-title');
        const songArtist = document.getElementById('song-artist');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const queueContainer = document.getElementById('queue-container'); 
        const fileInput = document.getElementById('file-input');

        let isPlaying = false;
        let isShuffle = false;
        let repeatMode = 'off'; // off, all, one
        let currentTrackId = null; 
        
        // Start with an empty playlist as requested
        let playlist = [];

        let draggingItem = null;

        function loadTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            const t = playlist[index];
            currentTrackId = t.id;
            audioPlayer.src = t.audio;
            songTitle.textContent = t.title;
            songArtist.textContent = t.artist;
            albumArt.src = t.art;
            renderQueue();
        }

        function togglePlay() {
            if (playlist.length === 0) return;
            if (!currentTrackId) loadTrack(0);
            
            if (isPlaying) {
                audioPlayer.pause();
            } else {
                audioPlayer.play().catch(() => {});
            }
            isPlaying = !isPlaying;
            updateUI();
        }

        function updateUI() {
            playPauseBtn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
            albumArt.classList.toggle('playing', isPlaying);
            
            shuffleBtn.classList.toggle('active', isShuffle);
            shuffleBtn.classList.toggle('text-gray-400', !isShuffle);

            repeatBtn.classList.remove('active', 'text-gray-400');
            const oldBadge = repeatBtn.querySelector('.repeat-one-badge');
            if (oldBadge) oldBadge.remove();

            if (repeatMode === 'off') {
                repeatBtn.classList.add('text-gray-400');
            } else {
                repeatBtn.classList.add('active');
                if (repeatMode === 'one') {
                    const badge = document.createElement('span');
                    badge.className = 'repeat-one-badge';
                    badge.textContent = '1';
                    repeatBtn.appendChild(badge);
                }
            }
        }

        function renderQueue() {
            queueContainer.innerHTML = '';
            if (playlist.length === 0) {
                queueContainer.innerHTML = '<div class="text-center text-gray-500 py-4">Queue is empty.</div>';
                return;
            }
            playlist.forEach((t, i) => {
                const item = document.createElement('div');
                item.className = `queue-item ${t.id === currentTrackId ? 'active' : ''}`;
                item.dataset.id = t.id;
                
                const handle = document.createElement('i');
                handle.className = "fas fa-bars drag-handle";
                
                handle.addEventListener('touchstart', (e) => {
                    draggingItem = item;
                    item.classList.add('dragging');
                }, { passive: false });

                handle.addEventListener('touchmove', (e) => {
                    if (!draggingItem) return;
                    e.preventDefault();
                    const touch = e.touches[0];
                    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                    const targetItem = elementBelow?.closest('.queue-item');
                    if (targetItem && targetItem !== draggingItem && queueContainer.contains(targetItem)) {
                        const items = [...queueContainer.querySelectorAll('.queue-item')];
                        if (items.indexOf(draggingItem) < items.indexOf(targetItem)) {
                            queueContainer.insertBefore(draggingItem, targetItem.nextSibling);
                        } else {
                            queueContainer.insertBefore(draggingItem, targetItem);
                        }
                    }
                }, { passive: false });

                handle.addEventListener('touchend', () => {
                    if (draggingItem) {
                        draggingItem.classList.remove('dragging');
                        draggingItem = null;
                        const newIds = [...queueContainer.querySelectorAll('.queue-item')].map(el => el.dataset.id);
                        playlist = newIds.map(id => playlist.find(p => p.id === id));
                    }
                });

                const info = document.createElement('div');
                info.className = 'track-info';
                info.innerHTML = `<div class="text-sm font-semibold truncate w-40">${t.title}</div><div class="text-xs opacity-60">${t.artist}</div>`;
                info.onclick = () => {
                    loadTrack(i);
                    isPlaying = false;
                    togglePlay();
                };

                const rmBtn = document.createElement('button');
                rmBtn.className = 'remove-btn';
                rmBtn.innerHTML = '<i class="fas fa-times"></i>';
                rmBtn.onclick = (e) => {
                    e.stopPropagation();
                    playlist = playlist.filter(p => p.id !== t.id);
                    if (currentTrackId === t.id) {
                        audioPlayer.pause();
                        isPlaying = false;
                        currentTrackId = null;
                        if (playlist.length > 0) loadTrack(0);
                        else {
                            songTitle.textContent = "Select a song";
                            songArtist.textContent = "";
                        }
                    }
                    updateUI();
                    renderQueue();
                };

                item.appendChild(handle);
                item.appendChild(info);
                item.appendChild(rmBtn);
                queueContainer.appendChild(item);
            });
        }

        shuffleBtn.onclick = () => {
            isShuffle = !isShuffle;
            updateUI();
        };

        repeatBtn.onclick = () => {
            if (repeatMode === 'off') repeatMode = 'all';
            else if (repeatMode === 'all') repeatMode = 'one';
            else repeatMode = 'off';
            updateUI();
        };

        function nextTrack() {
            if (playlist.length === 0) return;
            
            const curIndex = playlist.findIndex(t => t.id === currentTrackId);
            let nextIndex;

            if (isShuffle) {
                nextIndex = Math.floor(Math.random() * playlist.length);
            } else {
                nextIndex = curIndex + 1;
                // FIXED REPEAT ALL LOGIC:
                if (nextIndex >= playlist.length) {
                    if (repeatMode === 'all') {
                        nextIndex = 0; // Go back to start if repeat all is ON
                    } else {
                        // Stop if at end and repeat is OFF
                        audioPlayer.pause();
                        isPlaying = false;
                        updateUI();
                        return;
                    }
                }
            }
            
            loadTrack(nextIndex);
            audioPlayer.play().then(() => {
                isPlaying = true;
                updateUI();
            }).catch(e => console.error(e));
        }

        document.getElementById('next-btn').onclick = nextTrack;

        document.getElementById('prev-btn').onclick = () => {
            if (playlist.length === 0) return;
            const cur = playlist.findIndex(t => t.id === currentTrackId);
            let prevIndex = cur - 1;
            if (prevIndex < 0) prevIndex = playlist.length - 1;
            loadTrack(prevIndex);
            audioPlayer.play();
            isPlaying = true;
            updateUI();
        };

        playPauseBtn.onclick = togglePlay;

        audioPlayer.onended = () => {
            if (repeatMode === 'one') {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else {
                nextTrack();
            }
        };

        audioPlayer.ontimeupdate = () => {
            const p = (audioPlayer.currentTime / audioPlayer.duration) * 100 || 0;
            progressBar.style.width = `${p}%`;
            document.getElementById('current-time').textContent = formatTime(audioPlayer.currentTime);
        };
        audioPlayer.onloadedmetadata = () => {
            document.getElementById('duration').textContent = formatTime(audioPlayer.duration);
        };
        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sc = Math.floor(s % 60);
            return `${m}:${sc < 10 ? '0' : ''}${sc}`;
        }
        progressContainer.onclick = (e) => {
            const rect = progressContainer.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            audioPlayer.currentTime = pos * audioPlayer.duration;
        };
        document.getElementById('volume-slider').oninput = (e) => audioPlayer.volume = e.target.value;
        document.getElementById('clear-btn').onclick = () => {
            playlist = [];
            currentTrackId = null;
            audioPlayer.pause();
            isPlaying = false;
            updateUI();
            renderQueue();
            songTitle.textContent = "Select a song";
            songArtist.textContent = "";
        };
        document.getElementById('load-btn').onclick = () => fileInput.click();
        fileInput.onchange = (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const url = URL.createObjectURL(file);
                const newTrack = { 
                    id: Math.random().toString(36).substr(2, 9), 
                    title: file.name, 
                    artist: "Local", 
                    audio: url, 
                    art: `https://placehold.co/450x450/${Math.floor(Math.random()*16777215).toString(16)}/fff?text=Local` 
                };
                playlist.push(newTrack);
            });
            
            if (playlist.length > 0 && !currentTrackId) {
                loadTrack(0);
            }
            renderQueue();
            e.target.value = ''; // Reset input
        };

        window.onload = () => {
            renderQueue();
            updateUI();
        };
    </script>
</body>
</html>

